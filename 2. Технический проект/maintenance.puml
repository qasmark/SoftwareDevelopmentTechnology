@startuml
!theme vibrant

package "Кластер Kubernetes" as kubernetes {
  [Сервис обработки геолокации] as geo_service << (C, #FFAAAA) >>
  [Сервис авторизации] as auth_service << (C, #FFAAAA) >>
  [Сервис уведомлений] as notification_service << (C, #FFAAAA) >>
  [Сервис хранения данных] as data_service << (C, #FFAAAA) >>
}

package "HashiCorp Vault" as vault {
  [Transit Secrets Engine] as transit << (C, #FFAAAA) >>
  [Централизованное хранилище секретов] as secret_store << (C, #FFAAAA) >>
}

package "Обслуживание системы" as maintenance {
  actor "Системный администратор" as sys_admin
  actor "Разработчик" as developer
  actor "Тестировщик" as tester

  package "Мониторинг и управление" as monitoring {
    [Система мониторинга (Prometheus)] as monitoring_service << (C, #FFAAAA) >>
    [Система визуализации (Grafana)] as grafana_service << (C, #FFAAAA) >>
    [Система логирования (ELK)] as elk_service << (C, #FFAAAA) >>
    [Система бэкапов] as backup_service << (C, #FFAAAA) >>
  }
}

package "Разработка" as development {
  [Система контроля версий (Git)] as vcs << (C, #FFAAAA) >>
  
  package "CI/CD (Jenkins)" as cicd {
      [Сборка] as build_stage << (C, #FFAAAA) >>
      [Unit-тесты] as unit_test_stage << (C, #FFAAAA) >>
      [Интеграционные тесты] as integration_test_stage << (C, #FFAAAA) >>
      [E2E-тесты] as e2e_test_stage << (C, #FFAAAA) >>
      [Деплой] as deploy_stage << (C, #FFAAAA) >>
  }
}

package "Клиентское приложение" as client_app {
  [Flutter приложение] as flutter_app << (C, #FFAAAA) >>
}

sys_admin --> secret_store : "Управление секретами"
sys_admin --> monitoring_service : "Мониторинг состояния Vault и сервисов"
sys_admin --> grafana_service : "Просмотр дашбордов"
sys_admin --> elk_service : "Анализ логов"
sys_admin --> backup_service : "Создание бэкапов Vault"
developer --> sys_admin : "Запрос логов"

developer --> vcs : "PUSH изменений"
tester --> vcs : "PUSH тестов"
vcs --> build_stage : "Триггер сборки"
build_stage --> unit_test_stage : "Запуск Unit-тестов"
unit_test_stage --> integration_test_stage : "Запуск интеграционных тестов"
integration_test_stage --> e2e_test_stage : "Запуск E2E-тестов"
e2e_test_stage --> deploy_stage : "Запуск деплоя"

deploy_stage -[#blue]> geo_service : "Обновление\nсервиса"
' deploy_stage -[#blue]> auth_service : "Обновление сервиса"
' deploy_stage -[#blue]> notification_service : "Обновление сервиса"
' deploy_stage -[#blue]> data_service : "Обновление сервиса"

tester --> unit_test_stage : "Анализ результатов"
tester --> integration_test_stage : "Анализ результатов"
tester --> e2e_test_stage : "Анализ результатов"

monitoring_service --> secret_store : "Проверка состояния хранилища секретов"
monitoring_service --> geo_service : "Проверка состояния сервиса"
monitoring_service --> auth_service : "Проверка состояния сервиса"
monitoring_service --> notification_service : "Проверка состояния сервиса"
monitoring_service --> data_service : "Проверка состояния сервиса"
backup_service --> secret_store : "Восстановление из бэкапов"

flutter_app --> geo_service : "Запрос данных о местоположении"
flutter_app --> auth_service : "Аутентификация пользователя"
flutter_app --> notification_service : "Получение уведомлений"

data_service --> transit : "Шифрование данных"
geo_service --> transit : "Шифрование геолокационных данных"
auth_service --> transit : "Шифрование токенов доступа"
notification_service --> transit : "Шифрование уведомлений"

@enduml